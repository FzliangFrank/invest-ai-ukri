"0","#| code-summary: creating a plot function"
"0",""
"0","## some interesting events for time series"
"0",""
"0","events = tibble::tribble("
"0","  ~'year',~'description',"
"0","  '2020-03-31','First Covid lockdown',"
"0","  '2023-03-14', 'GPT4 Launch',"
"0","  '2023-11-01', 'AI Safety Summit',"
"0","  '2022-10-20','Mini-Budget'"
"0",") |> "
"0","  mutate(year=lubridate::ymd(year)) |> "
"0","  mutate(year_l =floor_date(year,""years""), year_r=ceiling_date(year,""years"")) |> "
"0","  mutate(across(starts_with(""year""), ~ as.Date(.x)))"
"0",""
"0","## write an annotation function to avoid boiler palette"
"0","add_hline_text=function(data, message='', color = '#E74C3C') {"
"0","  stopifnot(""`add_hline_text` is designed to take sepcific format""=all(c(""year"", ""n_diff"") %in% names(data)))"
"0","  "
"0","  return(list("
"0","  geom_linerange(data=data, aes(x=year,ymin=0,ymax=n_diff), "
"0","                 linetype=""dashed"", color = color, alpha=0.7),"
"0","  geom_point(data=data, aes(x=year,y=n_diff), color=color, shape=17),"
"0","  geom_richtext("
"0","    data=data, fill=NA,label.color = NA,size=2, color=color,hjust=-1,vjust=0,angle=-90,"
"0","    aes(x=year,y=n_diff,label=paste({{message}},'in', year(year)))),"
"0","  geom_richtext("
"0","    data=data, fill=NA,label.color = NA,size=2, color=color,hjust=0.5,vjust=0,angle=0,"
"0","    aes(x=year,y=n_diff,label= ifelse(n_diff > 10000, paste0(round(n_diff/1000),' k'),n_diff )))"
"0","  ))"
"0","}"
"0",""
"0","## plot the actual line"
"0","plot_freq = function(gtr, expr) {"
"0","  stopifnot(""Require `events` dataframe in parent frame, please load all code"""
"0","            =exists(""events"",envir = parent.env(environment())))"
"0","  ## exploration on investment rend"
"0","  gtr_freq = gtr |> "
"0","    select(StartDate, EndDate, AwardPounds) |> "
"0","    pivot_longer(cols = c(StartDate, EndDate)) |> "
"0","    mutate(year = ceiling_date(value,'years') - months(1)) |> "
"0","    group_by(name, year) |> "
"0","    summarise("
"0","      n = {{expr}},"
"0","      .groups = ""drop"""
"0","    ) |> "
"0","    filter(year < Sys.Date() |> floor_date(""years""))"
"0","  "
"0","  ## create a combined for differences"
"0","  to_end = gtr_freq |>"
"0","    filter(name=='EndDate') |> "
"0","    select(-name)"
"0","  to_start = gtr_freq |>"
"0","    filter(name=='StartDate') |> "
"0","    select(-name)"
"0","  merged=full_join("
"0","    to_start,to_end,"
"0","    by = c(""year""),suffix=c(""_to_start"", ""_to_end"")"
"0","    ) |> "
"0","    mutate(n_diff = n_to_start - n_to_end)"
"0","  "
"0","  ## event"
"0","  gtr_year_n_diff = select(merged,year,n_diff)"
"0","  events_m = events |>"
"0","    left_join(gtr_year_n_diff, by=c(""year_l""=""year"")) |>"
"0","    left_join(gtr_year_n_diff, by=c(""year_r""=""year""), suffix = c(""_l"",""_r"")) |>"
"0","    mutate(across(starts_with(""n_diff""), ~ replace_na(.x,0))) |>"
"0","    mutate(n_diff= (  n_diff_r - n_diff_l) * interval(year, year_l)/years(1) + n_diff_l )"
"0","  "
"0","  ## calculate peak  "
"0","  peak = merged |> "
"0","    filter(n_diff == max(n_diff)) |> "
"0","    select(year,n_diff)"
"0","  "
"0","  ## First Plot"
"0","  gtr_freq |> "
"0","    ggplot() +"
"0","    geom_line(aes(x = year, y = n, color = name)) + "
"0","    geom_point(aes(x = year, y = n, color = name)) +"
"0","    geom_area(data=merged, aes(x=year,y=n_diff),fill=""darkgrey"", alpha=0.2) + # add area"
"0","    add_hline_text(peak, ""<b>Live Project Peak</b>"") + # annotate"
"0","    geom_point(data=events_m, aes(x=year, y=0), color = ""#2980B9"",shape=17) +"
"0","    geom_richtext(data=events_m, aes(x=year, y=0, label=description), "
"0","                  color = ""#3498DB"",fill=NA,label.color = NA,size=2,hjust=1,vjust=0.5,angle=-90,"
"0","                  ) +"
"0","    scale_y_continuous(labels=comma) + "
"0","    scale_color_manual(values=c(""StartDate""=""blue"", ""EndDate""=""navy"")"
"0","                       ) +"
"0","    scale_x_date(date_breaks=""2 year"", date_labels=""%Y-%b"") +"
"0","    theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=1))"
"0","}"
